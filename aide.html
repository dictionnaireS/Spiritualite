<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictionnaire de Spiritualit√©</title>

    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Lora:ital,wght@0,400;0,700;1,400&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">

    <style>
        /* Loading Overlay pour PyScript */
        #pyscript_loading_splash {
            background-color: #f9f9f6;
            color: #1c2541;
            font-family: 'Lora', serif;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        :root {
            --primary-dark: #1c2541;
            --primary-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #1c2541 100%);
            --accent-gold: #d4af37;
            --bg-parchment: #f9f9f6;
            --text-dark: #2b2b2b;
            --text-light: #f5e6b3;
            --info-blue: rgba(232, 244, 248, 0.7);
            --border-blue: #3498db;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Lora', serif;
            background-color: var(--bg-parchment);
            background-image: radial-gradient(#d4af3710 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-dark);
            line-height: 1.4;
            font-size: 0.9rem;
        }

        header {
            background: var(--primary-gradient);
            color: var(--text-light);
            text-align: center;
            padding: 30px 20px;
            border-bottom: 3px solid var(--accent-gold);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        header p {
            font-size: 1.2rem !important;
            margin-bottom: 8px;
            opacity: 1;
            font-family: 'Cormorant Garamond', serif;
            font-weight: 600;
        }

        header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.4rem;
            font-weight: 700;
            margin: 0 auto;
            max-width: 900px;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            line-height: 1.2;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: var(--transition);
            margin-bottom: 15px;
        }

        .guide-box {
            background: var(--info-blue);
            border-left: 5px solid var(--border-blue);
        }

        .guide-box h3 {
            color: var(--primary-dark);
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-family: 'Merriweather', serif;
        }

        .guide-box ol {
            padding-left: 18px;
        }

        .guide-box li {
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: inline-block;
            margin-bottom: 8px;
            font-family: 'Lora', serif;
            font-weight: 600;
            color: #5c67f2;
            font-size: 1rem;
            background: #e8ebff;
            padding: 4px 12px;
            border-radius: 8px;
        }

        input[type="text"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #eaedf0;
            border-radius: 8px;
            font-family: 'Lora', serif;
            font-size: 0.9rem;
            background: #fff;
        }

        input:focus {
            outline: none;
            border-color: var(--border-blue);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .radio-item {
            position: relative;
            flex: 1;
            min-width: 100px;
        }

        .radio-item input {
            position: absolute;
            opacity: 0;
        }

        .radio-label {
            display: block;
            padding: 8px 5px;
            background: #fff;
            border: 1.5px solid #eaedf0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
        }

        .radio-item input:checked+.radio-label {
            border-color: #5c67f2;
            background: #5c67f2;
            color: #ffffff;
            font-weight: 600;
        }

        .btn-row {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--text-light);
        }

        .btn-primary:active {
            transform: translateY(1px);
        }

        .btn-primary:disabled {
            background: #dfe4ea;
            color: #a4b0be;
            cursor: not-allowed;
        }

        .btn-stop {
            background: #ffffff;
            color: #2b2b2b;
            border: 1px solid #dfe4ea;
        }

        .btn-stop span {
            color: #ff4757;
        }

        .results-section {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 20px;
            margin-top: 25px;
        }

        @media (max-width: 900px) {
            .results-section {
                grid-template-columns: 1fr;
            }
        }

        .results-area h3 {
            font-size: 1.2rem;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--accent-gold);
        }

        .pdf-placeholder {
            border: 2px dashed #d1d8e0;
            border-radius: 12px;
            padding: 30px 15px;
            text-align: center;
            color: #a4b0be;
            font-size: 0.8rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--bg-parchment);
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }

        .search-loader {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(52, 152, 219, 0.1);
            border-left-color: var(--border-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Style sp√©cifique pour la config API */
        .api-warning {
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 15px;
            border: 1px solid #ffeeba;
        }
    </style>
</head>

<body>

    <!-- Overlay de chargement initial -->
    <div id="pyscript_loading_splash">
        <div class="search-loader" style="width: 60px; height: 60px;"></div>
        <p style="margin-top: 20px;">Chargement du moteur Python...</p>
    </div>

    <!-- Configuration de l'environnement Python -->
    <py-config>
        packages = ["python-docx", "reportlab"]
        [splashscreen]
        enabled = false
    </py-config>

    <header>
        <p>Outil de recherche d'extraits du</p>
        <h1>Dictionnaire de Spiritualit√© Asc√©tique et Mystique</h1>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="card" style="background: #fff; border-left: 5px solid #27ae60;">
                <h3 style="font-size: 1rem; font-family: 'Merriweather'; color: #1c2541; margin-bottom: 5px;">üîó
                    Connexion S√©curis√©e</h3>
                <p style="font-size: 0.75rem; color: #666; margin-bottom: 0;">Connect√© via Hugging Face.</p>
                <div style="font-size: 0.7rem; color: #27ae60; margin-top: 5px;">‚óè Service Actif</div>
            </div>

            <div class="card guide-box">
                <h3>üìñ Guide</h3>
                <ol>
                    <li><b>VOLUME :</b> Choisissez un tome.</li>
                    <li><b>ORIENTATION :</b> S√©lectionnez un profil.</li>
                    <li><b>CRIT√àRES :</b> Th√®me + Mots-cl√©s.</li>
                    <li><b>EXPORT :</b> T√©l√©chargez en PDF.</li>
                </ol>
            </div>

            <div class="card" style="padding: 10px; border: none; background: transparent; box-shadow: none;">
                <button class="btn btn-primary" onclick="openContactModal()" style="width: 100%;">üìß NOUS
                    CONTACTER</button>
            </div>
        </aside>

        <main>
            <div class="card">
                <div class="form-group">
                    <label for="tome-select">Tome du dictionnaire</label>
                    <select id="tome-select">
                        <option value="Tome_1.docx">Tome I - Exemple (Local)</option>
                        <option value="Tome_2_1.docx">Tome II.1 - C √† D (Local)</option>
                        <!-- Ajoutez vos fichiers ici -->
                    </select>
                </div>

                <label>Profil de recherche</label>
                <div class="radio-group">
                    <div class="radio-item"><input type="radio" name="profil" id="p-equilibre" value="equilibre"
                            checked><label for="p-equilibre" class="radio-label">‚öñÔ∏è √âquilibr√©</label></div>
                    <div class="radio-item"><input type="radio" name="profil" id="p-spiritualite"
                            value="spiritualite_vivante"><label for="p-spiritualite" class="radio-label">üïäÔ∏è
                            Spiritualit√©</label></div>
                    <div class="radio-item"><input type="radio" name="profil" id="p-academique"
                            value="academique"><label for="p-academique" class="radio-label">üìö Acad√©mique</label></div>
                    <div class="radio-item"><input type="radio" name="profil" id="p-historique"
                            value="historique"><label for="p-historique" class="radio-label">üìñ Historique</label></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="theme-input">Th√©matique</label>
                        <input type="text" id="theme-input" placeholder="Ex: Oraison..." oninput="app_validate()">
                    </div>
                    <div class="form-group">
                        <label for="mots-cles-input">Mots-cl√©s</label>
                        <input type="text" id="mots-cles-input" placeholder="Ex: union, gr√¢ce..."
                            oninput="app_validate()">
                    </div>
                </div>

                <div class="btn-row">
                    <button id="search-btn" class="btn btn-primary" disabled py-click="start_search">‚ö†Ô∏è 2 crit√®res
                        requis</button>
                    <button id="stop-btn" class="btn btn-stop" py-click="stop_search"><span>üõë</span> ARR√äTER</button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-area">
                    <div class="card" style="min-height: 300px;">
                        <h3>üìä R√âSULTATS</h3>
                        <div id="results-content" style="color: #7f8c8d; font-style: italic; font-size: 0.85rem;">En
                            attente de recherche...</div>
                    </div>
                </div>
                <div class="pdf-area">
                    <div class="card">
                        <h3>üìï PDF</h3>
                        <div id="pdf-placeholder" class="pdf-placeholder"><span
                                style="font-size: 2.5rem; display: block; margin-bottom: 10px;">üìÑ</span>Disponible
                            apr√®s recherche.</div>
                        <div id="pdf-ready" style="display: none; text-align: center;">
                            <div class="pdf-ready-icon">‚öñÔ∏è</div>
                            <button id="pdf-download-btn" class="btn btn-primary" style="width: 100%;"
                                py-click="download_pdf">T√âL√âCHARGER LE PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeContactModal()">&times;</span>
            <h2 style="font-family: 'Cormorant Garamond', serif; margin-bottom: 25px;">üìß Contactez-nous</h2>
            <div class="form-group"><label>Email</label><input type="text" id="contact-email"></div>
            <div class="form-group"><label>Message</label><textarea id="contact-message" rows="5"></textarea></div>
            <button class="btn btn-primary" style="width: 100%;">ENVOYER (Non configur√© en d√©mo)</button>
        </div>
    </div>

    <footer>
        <p><b>Dictionnaire de Spiritualit√©</b> ‚Äî 2026</p>
    </footer>

    <script>
        // JS Helpers pour l'UI
        function closeLoadingSplah() { document.getElementById('pyscript_loading_splash').style.display = 'none'; }

        function app_validate() {
            const theme = document.getElementById('theme-input').value.trim();
            const mots = document.getElementById('mots-cles-input').value.trim();
            const btn = document.getElementById('search-btn');

            let count = 0;
            if (theme) count++;
            if (mots) {
                // S√©pare par virgule, compte double si 2 mots
                const parts = mots.split(',').filter(s => s.trim().length > 0);
                if (parts.length >= 2) count += 2;
                else if (parts.length === 1) count++;
            }

            if (count >= 2) {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ RECHERCHER';
            } else {
                btn.disabled = true;
                btn.innerHTML = '‚ö†Ô∏è 2 CRIT√àRES REQUIS';
            }
        }

        function openContactModal() { document.getElementById('contactModal').style.display = "block"; }
        function closeContactModal() { document.getElementById('contactModal').style.display = "none"; }
    </script>

    <!-- LOGIQUE PYTHON DANS LE NAVIGATEUR -->
    <py-script>
        import js
        import io
        import re
        import json
        import datetime
        from js import document, console, Uint8Array, window, File
        from pyodide.http import pyfetch
        from docx import Document
        from reportlab.lib.pagesizes import A4
        from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
        from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, HRFlowable, PageBreak
        from reportlab.lib.units import cm
        from reportlab.lib.colors import HexColor
        from reportlab.lib.enums import TA_CENTER, TA_JUSTIFY, TA_LEFT

        # Variables Globales
        global_pdf_buffer = None
        global_stop = False

        # üü¢ CONFIGURATION DU PROXY HUGGING FACE
        # Remplacez ceci par l'URL de votre Space HF
        HF_API_URL = "https://gildasr-cle.hf.space/ask_secure"

        # --- Fonctions Utilitaires ---
        def get_element(id): return document.getElementById(id)

        def afficher_loading(texte):
        result_div = get_element('results-content')
        result_div.innerHTML = f'<div class="search-loader"></div>
        <p style="text-align: center;">{texte}</p>'

        def afficher_erreur(msg):
        get_element('results-content').innerHTML = f'<p style="color: #ff4757; text-align: center;">‚ùå {msg}</p>'
        get_element('search-btn').disabled = False

        # --- Moteur de Recherche ---
        async def call_hf_proxy(prompt):
        try:
        # Appel au Proxy Hugging Face
        headers = {"Content-Type": "application/json"}
        body = json.dumps({"prompt": prompt})

        response = await pyfetch(HF_API_URL, method="POST", headers=headers, body=body)

        if response.status != 200:
        return None

        data = await response.json()
        return data.get('response', None) # Le proxy renvoie {"response": "..."}
        except Exception as e:
        console.log(f"Proxy Error: {str(e)}")
        return None

        async def start_search(event):
        global global_pdf_buffer, global_stop
        global_stop = False

        # 1. Config et Validation
        # Plus de v√©rification de cl√© API locale

        tome_file = get_element('tome-select').value
        theme = get_element('theme-input').value
        mots = get_element('mots-cles-input').value
        profil = document.querySelector('input[name="profil"]:checked').value

        get_element('search-btn').disabled = True
        get_element('pdf-placeholder').style.display = 'block'
        get_element('pdf-ready').style.display = 'none'

        # 2. Chargement du fichier Docx (Local/Relatif)
        afficher_loading(f"Chargement du {tome_file}...")
        try:
        # On fetch le fichier h√©berg√© sur GH Pages
        response = await pyfetch(tome_file, method="GET")
        content = await response.bytes()

        # Lecture Docx via io
        doc = Document(io.BytesIO(content))
        chunks = []
        curr = ""
        for p in doc.paragraphs:
        curr += p.text + "\n"
        if len(curr) > 5000:
        chunks.append(curr)
        curr = ""
        if curr: chunks.append(curr)

        except Exception as e:
        afficher_erreur(f"Erreur chargement fichier: {str(e)}")
        return

        # 3. Recherche Vectorielle Simplifi√©e
        afficher_loading("Analyse des passages...")
        scores = []
        keywords = (theme + " " + mots).lower().split()

        for i, chunk in enumerate(chunks):
        if global_stop: break
        text_lower = chunk.lower()
        score = 0
        for k in keywords:
        if len(k) > 3 and k in text_lower: score += 1
        if score > 0:
        scores.append({'id': i, 'score': score, 'text': chunk})

        scores.sort(key=lambda x: x['score'], reverse=True)
        top_chunks = scores[:3]

        if not top_chunks:
        afficher_erreur("Aucun passage pertinent trouv√©.")
        return

        # 4. Extraction IA
        afficher_loading("Extraction pr√©cise (IA)...")
        passages_finaux = []

        for item in top_chunks:
        if global_stop: break
        prompt = f"Analyse ce texte et extrais un passage pertinent sur: {theme}, {mots}. Format JSON:
        {{passages:[{{texte:'...', titre:'...', contexte:'...'}}]}}. Texte: {item['text'][:3000]}"

        # Appel via le Proxy
        res = await call_hf_proxy(prompt)

        if res:
        try:
        clean_json = re.search(r'\{.*\}', res, re.DOTALL).group(0)
        data = json.loads(clean_json)
        passages_finaux.extend(data.get('passages', []))
        except: pass

        if not passages_finaux:
        afficher_erreur("L'IA n'a pas pu extraire de citations pr√©cises.")
        return

        # 5. Affichage HTML
        html = f"<h4>‚úÖ {len(passages_finaux)} passages trouv√©s</h4>"
        for i, p in enumerate(passages_finaux, 1):
        html += f"""<div class="card"
            style="background:#fff; border-left:4px solid #d4af37; padding:15px; margin-bottom:15px;">
            <h5 style="color:#1c2541; margin-bottom:5px;">{p.get('titre', f'Extrait {i}')}</h5>
            <p style="font-style:italic; font-size:0.9rem;">"{p.get('texte','')}"</p>
        </div>"""

        get_element('results-content').innerHTML = html

        # 6. G√©n√©ration PDF (M√©moire)
        global_pdf_buffer = generer_pdf_memoire(passages_finaux, {'theme': theme, 'mots_cles': mots})

        get_element('pdf-placeholder').style.display = 'none'
        get_element('pdf-ready').style.display = 'block'
        get_element('search-btn').disabled = False

        def stop_search(event):
        global global_stop
        global_stop = True
        get_element('results-content').innerHTML += "<br><b>üõë Arr√™t demand√©...</b>"

        def download_pdf(event):
        global global_pdf_buffer
        if not global_pdf_buffer: return

        # Cr√©ation d'un Blob et t√©l√©chargement JS
        js_array = Uint8Array.new(global_pdf_buffer.getvalue())
        blob = window.Blob.new([js_array], {type: "application/pdf"})
        url = window.URL.createObjectURL(blob)

        link = document.createElement("a")
        link.href = url
        link.download = f"Resultats_Dictionary_{int(datetime.datetime.now().timestamp())}.pdf"
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)

        # --- G√©n√©rateur PDF (ReportLab Custom) ---
        def entete_pied_page_latex(canvas, doc):
        canvas.saveState()
        canvas.setFillColor(HexColor('#FDF8F0'))
        canvas.rect(0, 0, A4[0], A4[1], fill=1, stroke=0)
        canvas.setStrokeColor(HexColor('#CCCCCC'))
        canvas.setLineWidth(0.5)
        canvas.line(2*cm, A4[1] - 1.5*cm, A4[0] - 2*cm, A4[1] - 1.5*cm)
        canvas.setFont('Times-Italic', 9)
        canvas.setFillColor(HexColor('#555555'))
        canvas.drawString(2*cm, A4[1] - 1.2*cm, "Extraits du Dictionnaire de Spiritualit√©")
        canvas.line(2*cm, 1.5*cm, A4[0] - 2*cm, 1.5*cm)
        canvas.restoreState()

        def generer_pdf_memoire(passages, criteres):
        buffer = io.BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=A4, leftMargin=2*cm, rightMargin=2*cm, topMargin=2.5*cm,
        bottomMargin=2.5*cm)
        styles = getSampleStyleSheet()

        style_titre = ParagraphStyle('TitreLatex', parent=styles['Heading1'], fontSize=18, fontName='Times-Bold',
        textColor=HexColor('#1a1a1a'), alignment=TA_CENTER, spaceAfter=20)
        style_extrait = ParagraphStyle('ExtraitLatex', parent=styles['BodyText'], fontSize=11, fontName='Times-Roman',
        textColor=HexColor('#333333'), alignment=TA_JUSTIFY)

        story = []
        story.append(Spacer(1, 1*cm))
        story.append(Paragraph("EXTRAITS DU DICTIONNAIRE", style_titre))
        story.append(Spacer(1, 1*cm))

        for i, p in enumerate(passages, 1):
        story.append(Paragraph(f"<b>{i}. {p.get('titre', 'Extrait')}</b>", styles['Heading3']))
        story.append(Paragraph(p['texte'], style_extrait))
        story.append(Spacer(1, 0.5*cm))
        story.append(HRFlowable(width="100%", thickness=0.5, color=HexColor('#ddd')))
        story.append(Spacer(1, 0.5*cm))

        doc.build(story, onFirstPage=entete_pied_page_latex, onLaterPages=entete_pied_page_latex)
        return buffer

        # Fin du chargement
        js.closeLoadingSplah()
    </py-script>

</body>

</html>